---
title: "Tutorial of Standardized Mortality Ratio (SMR) in R"
author: "Grace Zhou"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: show  # or "hide"
    toc: true
    toc_depth: 3
    toc_float: true
    theme: cosmo
---
  
```{r setup, include=FALSE}

knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

```

# Introduction

This document outlines the process for estimating Standardized Mortality Ratios (SMRs) for a study cohort over a specified observation period.

# R version

```{r}

R.Version()

```


# Load package

```{r}

library(dplyr)      # Data management
library(lubridate)  # Date management

```

# Define function

## getPersonYear

```{r ftn1, class.source="fold"}

################################################################
# Purpose: Convert ageyear.sas into R functions
# Author: Grace Zhou
# Date: 2025-06-03
# Source: Source/ageyear.sas
################################################################
#' getPersonYear
#'
#' For each person, splits follow-up time into calendar years and calendar birthday (birthday in that calendar year), calculates person-years weight (pyear) and age (agey) for each interval,
#' and assigns CDC age categories.
#'
#' @param id         Vector of person IDs
#' @param sex        Vector of sex (1=male, 2=female)
#' @param birth.date Vector of birth dates (Date)
#' @param start.date Vector of follow-up start dates (Date)
#' @param end.date   Vector of follow-up end dates (Date)
#'
#' @return Data frame with one or more rows per person per calendar birthday, including input params, person-years weight (pyear), CDC age categories.
#'
#' @details
#' - Splits follow-up into calendar years between start.date and end.date.
#' - For each year, splits time at birthday to get pre- and post-birthday intervals.
#' - Calculates person-years (pyear) for each interval.
#' - Calculates age at start of each interval (agey, floored).
#' - Assigns CDC age category (agecat_cdc) and sex category (sex_cdc).
#'
#' @examples
#' getPersonYear(1, 1, as.Date("2000-01-01"), as.Date("2010-06-01"), as.Date("2012-08-15"))
getPersonYear <- function(id, sex, birth.date, start.date, end.date) {
  
  require(lubridate)
  require(dplyr)
  require(tidyr)
  
  # Input validation
  if (!is.Date(birth.date)) stop("birth.date must be in date format")
  if (!is.Date(start.date)) stop("start.date must be in date format")
  if (!is.Date(end.date)) stop("end.date must be in date format")
  
  # Combine input vectors into a data frame
  indata <- data.frame(
    id = id,
    sex = sex,
    birth.date = birth.date,
    start.date = start.date,
    end.date = end.date
  )
  
  # Expand each record to one row per calendar year in follow-up
  indata2 <- indata %>%
    rowwise() %>%
    mutate(
      calyear = list(year(start.date):year(end.date)) # Sequence of calendar years
    ) %>%
    tidyr::unnest(calyear) %>%
    ungroup() %>%
    mutate(
      calbirth_date = ymd(paste0(calyear, sprintf("-%02d-%02d", month(birth.date), day(birth.date)))), # Birthday in each year
      calstart_date = ymd(paste0(calyear, "-01-01")),  # Jan 1 of each year
      calend_date   = ymd(paste0(calyear, "-12-31"))   # Dec 31 of each year
    )
  
  # For each year, split into pre- and post-birthday intervals
  pre.indata3 <- indata2 %>%
    rowwise() %>%
    mutate(
      st1 = max(start.date, calstart_date),           # Start of pre-birthday interval
      ed1 = min(calbirth_date, end.date),             # End of pre-birthday interval
      st2 = max(calbirth_date, start.date),           # Start of post-birthday interval
      ed2 = min(end.date, calend_date)                # End of post-birthday interval
    ) %>%
    ungroup()
  
  # Calculate person-years in each interval
  indata3 <- pre.indata3 %>%
    mutate(
      preCalBirth  = time_length(interval(st1, ed1), 'years'),   # Person-years before calendar birthday
      postCalBirth = time_length(interval(st2, ed2), 'years')    # Person-years after calendar birthday
    )
  
  # Reshape to long format: one row per interval (pre/post birthday)
  indata4 <- indata3 %>%
    tidyr::pivot_longer(
      cols = c('preCalBirth', 'postCalBirth'),
      names_to = 'CalBirth',
      values_to = 'pyear'
    ) %>%
    filter(pyear > 0) # Keep only intervals with positive person-years
  
  # Calculate age at start of each interval
  indata5 <- indata4 %>%
   mutate(
      age = case_when(
        CalBirth == 'preCalBirth'  ~ time_length(interval(birth.date, st1), 'years'),
        CalBirth == 'postCalBirth' ~ time_length(interval(birth.date, calbirth_date), 'years')
      ),
      agey = floor(age) # Integer age
    ) %>%
    ungroup()
  
  # Assign CDC age and sex categories, and output columns
  outdata <- indata5 %>%
    mutate(
      agecat_cdc = cut(
        agey,
        breaks = c(0, 1, 5, 10, 15, 20, 25, 35, 45, 55, 65, 75, 85, Inf),
        include.lowest = TRUE,
        right = FALSE,
        labels = as.character(1:13)
      ),
      sex_cdc = sex
    ) %>%
    rename(year_cdc = calyear) %>%
    select(all_of(names(indata)), contains('_cdc'), pyear, agey)
  
  return(outdata)
}

```

## getSMR

```{r ftn2, class.source="fold"}
################################################################
# Purpose: get SMR result
# Author: Grace Zhou
# Date: 2025-06-06
# Reference: https://www.openepi.com/PDFDocs/SMRDoc.pdf
################################################################
# Function to calculate SMR and confidence intervals
#' getSMR
#'
#' Calculates the Standardized Mortality Ratio (SMR) and confidence intervals for observed and expected deaths.
#' Uses exact Poisson confidence intervals for small observed counts (<=5), and Byar's approximation otherwise.
#'
#' @param cause_label Character. Label for the mortality cause.
#' @param obs.no Integer. Number of observed deaths.
#' @param exp.no Numeric. Number of expected deaths.
#' @param digits Integer. Number of digits to round results (default: 2).
#' @param conf.level Numeric. Confidence level for interval (default: 0.95).
#' @param alternative Character. Alternative hypothesis for p-value calculation ("two.sided", "less", "greater").
#'
#' @return A tibble with SMR, confidence interval, and p-value.
#'
#' @details
#' - If obs.no <= 5, uses exact Poisson confidence interval via exactci::poisson.exact.
#' - Otherwise, uses Byar's approximation for confidence interval and p-value.
#'
#' @examples
#' getSMR("Example", obs.no = 4, exp.no = 3.3)
#' 
getSMR <- function(cause_label, obs.no, exp.no, digits = 2, conf.level = 0.95, alternative = c('two.sided', 'less', 'greater')) {
  alternative <- match.arg(alternative)
  
  # Use exact Poisson for small observed counts, Byar's approximation otherwise
  if (obs.no <= 5) {
    if (!requireNamespace("exactci", quietly = TRUE)) install.packages("exactci")
    library(exactci)
    result <- poisson.exact(obs.no, exp.no, midp = TRUE, conf.level = conf.level, alternative = alternative)
  } else {
    # Byar's approximation for Poisson confidence interval
    byar_approx <- function(x, T = 1, conf.level = 0.95, alternative = 'two.sided') {
      if (x < 0) stop("Observed count must be non-negative")
      if (T <= 0) stop("Expected count must be positive")
      alpha <- 1 - conf.level
      z <- qnorm(1 - alpha / 2)
      SMR <- x / T
      # Byar's confidence interval
      if (x == 0) {
        lower <- 0
        upper <- (1 - (alpha / 2)^(1 / (x + 1))) / T
      } else {
        lower <- x * (1 - 1 / (9 * x) - z / (3 * sqrt(x)))^3 / T
        upper <- (x + 1) * (1 - 1 / (9 * (x + 1)) + z / (3 * sqrt(x + 1)))^3 / T
      }
      # Test statistic and p-value
      if (x >= T) {
        statistic <- sqrt(9 * x) * (1 - 1 / (9 * x) - (T / x)^(1 / 3))
      } else {
        statistic <- sqrt(9 * (x + 1)) * (1 - 1 / (9 * (x + 1)) - (T / (x + 1))^(1 / 3))
      }
      p_value <- switch(alternative,
                        "two.sided" = 2 * (1 - pnorm(abs(statistic))),
                        "greater" = 1 - pnorm(statistic),
                        "less" = pnorm(statistic)
      )
      result <- list(
        statistic = c(count = x),
        parameter = c(expected = T, conf.level = conf.level),
        alternative = alternative,
        null.value = c(rate = 1),
        conf.int = structure(c(lower, upper), conf.level = conf.level),
        estimate = c(rate = SMR),
        p.value = p_value,
        method = "Byar's approximation",
        data.name = deparse(substitute(x))
      )
      class(result) <- "htest"
      return(result)
    }
    result <- byar_approx(obs.no, exp.no, conf.level = conf.level, alternative = alternative)
  }
  
  # Format p-value for display
  p_value_formatted <- function(p, eps = .0001) {
    ifelse(p < eps, 
           format.pval(p, digits = 4, eps = eps),  # Returns "<0.0001"
           format(round(p, 4), nsmall = 4))          # Returns "0.1234"
  }
    
  
  # Output as tibble for easy reporting
  tibble(
    MORTALITY = cause_label,
    EXP_NUM = exp.no,
    OBS_NUM = obs.no,
    SMR = unname(round(result$estimate, digits)),
    "{conf.level * 100}% LCI" := round(result$conf.int[1], digits),
    "{conf.level * 100}% UCI" := round(result$conf.int[2], digits),
    "p-value ({alternative})" := p_value_formatted(result$p.value)
  )
}


```

## getSMROutput

```{r ftn3, class.source="fold"}

# Efficient helper to summarize expected and observed deaths for a given cause
#' getSMROutput
#'
#' Helper function to summarize expected and observed deaths for a given cause and calculate the Standardized Mortality Ratio (SMR).
#'
#' @param col Character. Name of the CDC cause column in CDC_PY (e.g., "allcause", "sncause", etc.).
#' @param dcat_value Character or NULL. Death category value from 'mydt' to filter observed deaths. Use NULL for all-cause mortality.
#'
#' @details
#' - Requires data frames: CDC_PY (person-years merged with CDC rates) and mydt (study cohort).
#' - Calculates expected deaths by summing person-years weighted by CDC rates.
#' - Calculates observed deaths by counting records in mydt with LIVEDEAD == 2 (and DCAT == dcat_value if specified).
#' - Calls getSMR to compute SMR and confidence intervals.
#'
#' @return A tibble with SMR, confidence interval, and p-value for the specified cause.
#'
#' @examples
#' getSMROutput("allcause")
#' getSMROutput("sncause", "Subsequent~neoplasm")
getSMROutput <- function(col=c('allcause','sncause','smncause','cardcause','pulcause','extcause','othcause'), 
                          dcat_value = c(NULL,'Subsequent~neoplasm', 'Subsequent~malignant~neoplasm', 'Cardiac~causes', 'Pulmonary~causes','External~causes','Other~causes')) {

  cause_label <- switch(col,
                        "allcause"='All-cause',
                        "sncause"='Subsequent~neoplasm',
                        "smncause"='Subsequent~malignant~neoplasm',
                        "cardcause"='Cardiac~causes',
                        "pulcause"='Pulmonary~causes',
                        "othcause"='Other~causes',
                        "extcause"='External~causes'
  )
  
  exp.no <- CDC_PY %>% summarize(exp.no = sum(pyear * .data[[col]] / 1000, na.rm = TRUE)) %>% pull(exp.no)
  
  if (is.null(dcat_value)) {
    obs.no <- mydt %>% filter(LIVEDEAD == 2) %>% tally() %>% pull(n)
  } else {
    obs.no <- mydt %>% filter(LIVEDEAD == 2 & DCAT == dcat_value) %>% tally() %>% pull(n)
  }
  
  getSMR(cause_label, obs.no, exp.no)
  
}

```

# Data Example

We will read in a sample data and demonstrate the usage of the function to achieve the SMR results for all-cause mortality.

## Step 1: Load Study Data (one record per person)

```{r step1}

# Required columns:
#   ID: subject id
#   D_BIRTH: birth date
#   D_ENTRY: study start date
#   SEX: 1=male, 2=female
#   LIVEDEAD: 1=alive until NDI (e.g., 2021-12-31), 2=dead before NDI
#   DCAT: death category: 'Subsequent~neoplasm', 'Cardiac~causes', 'Pulmonary~causes','External~causes','Other~causes'
#   D_DEATH: date of death (if applicable)
#   D_END: study end date (derived below)

mydt <- read.csv('Data/sampleDT.csv') %>%
  mutate(
    D_BIRTH = ymd(D_BIRTH),   # Convert character to Date (if your data is already in Date format, you can skip this step)
    D_ENTRY = ymd(D_ENTRY),   # Convert character to Date
    D_DEATH = ymd(D_DEATH)    # Convert character to Date
  ) %>%
  group_by(ID) %>%
  mutate(
    D_END = min(D_DEATH, ymd('2021-12-31'), na.rm = TRUE) # End at death or censor date
  ) %>%
  ungroup()

```

## Step 2: Calculate person-years for each subject (see getPersonYear.R for function details)

We can specify the subject ID, sex, birth date, start date and end date to *getPersonYear* function. 
```{r step2}

mydt.py <- getPersonYear(
  id = mydt$ID,
  sex = mydt$SEX,
  birth.date = mydt$D_BIRTH,
  start.date = mydt$D_ENTRY,
  end.date = mydt$D_END
)

```

The returned output is a data frame with additional columns: weight (pyear) and CDC age category (agecat_cdc).  

```{r}

mydt.py %>% slice(1:5)

```

## Step 3: Load CDC reference rates and merge with person-year data

```{r step3}

CDC.1975.2022 <- read.csv('CDC/CDC1975_2022.csv') # CDC rates per 1000 persons (collected and derived by Grace Zhou on 2024-09-30)
CDC_PY <- merge(mydt.py, CDC.1975.2022, by = c('agecat_cdc', 'sex_cdc', 'year_cdc'))

```

## Step 4: Get SMR estimate for all-cause mortality

```{r step4}

all.cause <- getSMROutput('allcause', dcat_value=NULL)
all.cause 

```

## Step 5: Get SMR estimates for multiple death causes

```{r step5}

sn.cause   <- getSMROutput('sncause',   'Subsequent~neoplasm')
card.cause <- getSMROutput('cardcause', 'Cardiac~causes')
pul.cause  <- getSMROutput('pulcause',  'Pulmonary~causes')
oth.cause  <- getSMROutput('othcause',  'Other~causes')
ext.cause  <- getSMROutput('extcause',  'External~causes')

# Combine all results into one output table
output <- bind_rows(all.cause, sn.cause, card.cause, pul.cause, oth.cause, ext.cause)

output

```

Based on the table, we conclude that the study cohort exhibits a 55% higher overall mortality compared to the general population, which is statistically significant. Notably, the SMR for subsequent neoplasm-related deaths is extremely high at 9.24. Cardiac-related mortality is also significantly elevated. Although pulmonary-related mortality shows an increased risk (SMR = 2.63), it is not statistically significant due to the small number of cases (n = 3). Mortality from external causes, such as accidents or suicides, appears comparable to that of the general population.

# Conclusion

This document demonstrates how to derive person-year data and calculate Standardized Mortality Ratios (SMRs) for specific causes of death, along with generating well-formatted output. By following the outlined steps, users can efficiently obtain point estimates, 95% confidence intervals, and p-values. The tutorial also addresses appropriate handling of SMRs when the number of observed deaths is fewer than five. With the use of a customized function, this pipeline streamlines the SMR estimation process.

# References

https://www.openepi.com/PDFDocs/SMRDoc.pdf

https://www.cdc.gov/nchs/nvss/deaths.htm





